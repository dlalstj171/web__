<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>여행 후기</title>

  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/review_list.css">
  
  <style>
    /* 삭제 버튼 스타일 추가 */
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.3s;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
    .review-actions {
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo"><img src="logo.png" alt="로고"></div>
    <nav>
      <ul>
        <li><a href="main.html">| HOME |</a></li>
        <li><a href="region.html">| 주요도시 |</a></li>
        <li><a href="review_list.html">| 여행 후기 |</a></li>
        <li><a href="guide.html">| 이용가이드 |</a></li>
        <li><a href="qna.html">| Q&A |</a></li>
        <li><a href="index.html">| 포트폴리오 |</a></li>
      </ul>
    </nav>
  </header>

  <main class="review-list-page">
    <section class="review-list-card">
      <div class="review-list-header">
        <h1>REAL REVIEW</h1>
        <p>여행자들의 생생한 후기를 만나보세요.</p>
      </div>

      <div class="filter-bar">
        <label for="filterRegion">지역별 보기</label>
        <select id="filterRegion">
          <option value="">전체 지역</option>
          <option value="서울">서울</option><option value="인천">인천</option><option value="대전">대전</option>
          <option value="대구">대구</option><option value="광주">광주</option><option value="부산">부산</option>
          <option value="울산">울산</option><option value="경기도">경기도</option><option value="강원도">강원도</option>
          <option value="충청도">충청도</option><option value="경상도">경상도</option><option value="전라도">전라도</option>
          <option value="제주도">제주도</option><option value="세종">세종</option>
        </select>
      </div>

      <a href="review.html" class="write-btn">후기 작성하기</a>

      <div id="reviewList" class="review-list">
        </div>
    </section>
  </main>

<script>
  const API_BASE = "http://localhost:3000";

  async function fetchReviews() {
    const container = document.getElementById('reviewListContainer'); 
    // (위 ID는 실제 html에 있는 목록 담는 div id여야 합니다. 
    // 혹시 id가 다르다면 확인해주세요. 보통 'review-list' 등으로 되어있을 수 있습니다.)
    
    // 만약 container를 못 찾으면 에러 나니까 안전장치
    const listElement = document.querySelector('.review-list') || document.getElementById('reviewList');
    
    if (!listElement) {
        console.error("리뷰 목록을 넣을 div를 찾지 못했습니다.");
        return;
    }
    
    // 초기화
    listElement.innerHTML = "<p>로딩 중...</p>";

    try {
      // 1. 서버에서 리뷰 데이터 가져오기
      const res = await fetch(`${API_BASE}/api/reviews`);
      const reviews = await res.json();

      listElement.innerHTML = ""; // 로딩 글씨 지우기

      if (reviews.length === 0) {
        listElement.innerHTML = "<p>등록된 리뷰가 없습니다.</p>";
        return;
      }

      // 2. 리뷰 하나씩 화면에 그리기
      reviews.forEach(review => {
        
        // ★ [핵심] 사진이 있는지 확인하는 코드
        // DB에 image_path가 있으면 <img> 태그를 만들고, 없으면 빈칸('')으로 둡니다.
        let imageHtml = '';
        if (review.image_path) {
            imageHtml = `
              <div style="margin-top: 10px;">
                <img src="${API_BASE}${review.image_path}" 
                     alt="여행 사진" 
                     style="max-width: 150px; height: auto; border-radius: 8px; border: 1px solid #ddd;">
              </div>
            `;
        }

        // 별점(숫자) -> 별 모양(★)으로 바꾸기
        const starStr = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
        const dateStr = new Date(review.created_at).toLocaleString();

        // HTML 조립
        const html = `
          <div class="review-item" style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <span style="background: #eef; color: #33a; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 5px;">
                  ${review.region}
                </span>
                <span style="color: #f39c12; font-weight: bold;">${starStr}</span>
              </div>
              <div style="font-size: 0.8em; color: #888;">${dateStr}</div>
            </div>

            <div style="font-weight: bold; margin-bottom: 5px;">${review.content}</div>
            
            ${imageHtml}

            <div style="margin-top: 10px; font-size: 0.9em; color: #666; display: flex; justify-content: space-between;">
              <span>작성자: <strong>${review.nickname || review.writerId || '익명'}</strong></span>
              <button onclick="deleteReview(${review.id})" style="background: #ff5555; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">삭제</button>
            </div>
          </div>
        `;

        listElement.insertAdjacentHTML('beforeend', html);
      });

    } catch (err) {
      console.error(err);
      listElement.innerHTML = "<p>리뷰를 불러오는 데 실패했습니다.</p>";
    }
  }

  // 삭제 기능 (기존 유지)
  async function deleteReview(id) {
    const password = prompt("리뷰 삭제를 위해 비밀번호를 입력해주세요.");
    if (!password) return;

    try {
      const res = await fetch(`${API_BASE}/api/reviews/${id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      
      if (res.ok) {
        alert("삭제되었습니다.");
        fetchReviews(); // 목록 새로고침
      } else {
        alert(data.message);
      }
    } catch (err) {
      alert("삭제 중 오류 발생");
    }
  }

  // 페이지 열리면 실행
  document.addEventListener('DOMContentLoaded', fetchReviews);
</script>
</body>
</html>